language: python

cache:
  directories:
    - "/opt/sharedlibs"

env:
  global:
    - CLOUDSDK_CORE_DISABLE_PROMPTS=1
    - CLUSTER_NAME=standard-cluster-1
    - CLUSTER_PROJECT=gcp-home-dev
    - CLUSTER_ZONE=europe-west3-a
    - DEPLOYMENT_NAME=salt
    - IMAGE_MASTER=gcr.io/gcp-home-dev/saltstack-master:377e674f80345c688f65baedbae9be43a69de52f
    - IMAGE_MINION=gcr.io/gcp-home-dev/github.com/cookiiiies/images:b8604f71756937e3ae05a5413488ab6fdeebcbba
    - IMAGE_NGINX=gcr.io/gcp-home-dev/github.com/cookiiiies/images:38653e4be94ea748251de9c5c86a32106278e481
    - MAX_REPLICAS=1
    - MIN_REPLICAS=1
    - NAMESPACE=salt
    - API_USERNAME=saltdeployer
    - SALT_API_HOST=salt.th0r.lan
    - secure: "NI8vGrzHw77nkSXv/tfMwey3Tm6X4gKWLGztwtLQQ7oeDigtYiZHkbVN0ETxNkerm5Dg+FkJz+dkm9jOcdri+N6c1982IcjrPQQLBBNMzZDRnA/QiwuDeQ1Fhq/Z/2UKHWKKG7DG4bGGblf2T1jopnFPG4mCDYqQIQSuMDvO0jmdKA3cjm05uhRGytohmlLueDoPPW1tDD7mu8Apk36CVb7BDqDBaQFlnLv7+Vldxd499CcaOFF5/ZrpC9/XVa42bv31VuhiDhdTcE3ARvOIHuaTH7S0BYXTXwOz0Fzhh7OKqUWSnCz0MOEQppFfjXx1F8kesA1K5Hau6EP/23ueQxxDgHIWy/4L1YeGuroDbetDL2iBgfcV+KaoDbpCYqOwPQjeGczwP1pU+xGD0GitIiJc5t+bJLxF7Klvnjz1SkAOTN48LY0KJgheM7SlmTthqPdDQnLIFCKo6dW7KTzyHFgJrAHh2q7+1jonjxYnnUndA4O3kA266pUb2u/kDUqOCaElgyc6rTHvLSR+AddBauz/1JkfU2OvOJTW8VR7NIL1kS5tjmtD0dMNvzkxCik2o2c82w5Zk/mkZ8Yn5J32on43bXu6nFe8g3QY2uR6UuGGX8g09aKpQ06R5Lvn1ks8z1X78dXe5m7fjQ/AbQxKfulFjj9hGVIvfyTudzURGqQ="

before_install:
  - >-
      openssl aes-256-cbc -K $encrypted_ffc671bd29c0_key -iv $encrypted_ffc671bd29c0_iv
      -in credentials.tar.gz.enc -out credentials.tar.gz -d
  # credentials.tar.gz contains:
  # - saltdeloyer-gpg.priv
  # - saltdeployer.priv
  # - saltdeloyer.pub
  # - saltstack_deployment_secret.json
  - tar -xzf credentials.tar.gz
  - sudo apt-get install apt-transport-https git
  - export CLOUD_SDK_REPO="cloud-sdk-$(lsb_release -c -s)"
  - >-
      echo "deb https://packages.cloud.google.com/apt $CLOUD_SDK_REPO main" |
      sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
  - curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
  - sudo apt-get update
  - mkdir -p /opt/sharedlibs/
  - >-
      /bin/bash -c
      'if ls /opt/sharedlibs/.git ;
      then git -C /opt/sharedlibs/ pull;
      else git clone https://github.com/Cookiiiies/sharedlibs.git /opt/sharedlibs/; fi'

install:
  - pip install -r pip/requirements.txt
  - sudo apt-get install google-cloud-sdk kubectl
  - kubectl version --client
  - gcloud --version
  - mkdir -p ${HOME}/k8s_descriptions
  - gcloud auth activate-service-account --key-file saltstack_deployment_secret.json
  - >-
      gcloud container clusters get-credentials ${CLUSTER_NAME}
      --zone ${CLUSTER_ZONE}
      --project ${CLUSTER_PROJECT}

before_script:
  - export GPG_SALTDEPLOYER_PRIVATE_KEY=$(base64 -w0 saltdeloyer-gpg.priv)
  - export SSH_SALTDEPOYER_PUB=$(base64 -w0 saltdeployer.pub)
  - export SSH_SALTDEPLOYER_PRIV=$(base64 -w0 saltdeployer.priv)

script:
  - python2 /opt/sharedlibs/python/render_k8s.py
  - python2 /opt/sharedlibs/python/deploy_k8s.py
