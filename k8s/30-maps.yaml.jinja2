kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ DEPLOYMENT_NAME }}-minion-config
  namespace: {{ NAMESPACE }}
data:
 salt-minion.conf: |

    ############################################
    # salt master configuration
    master: {{ DEPLOYMENT_NAME }}-master

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ DEPLOYMENT_NAME }}-master-config
  namespace: {{ NAMESPACE }}
data:
 salt-master.conf: |
    ############################################
    # salt api configuration

    rest_cherrypy:
      port: 8081
      disable_ssl: True

    external_auth:
      pam:
        {{ API_USERNAME }}:
          - '@wheel':
            - key.gen_accept

    ############################################
    # pillar configuration

    ext_pillar_first: True

    pillar_merge_lists: true

    ext_pillar:
      - git:
        - base git@github.com:Cookiiiies/pillar.git:
          - env: base
          - root: pillar
          - privkey: /etc/salt/secrets/ssh_keys/saltdeployer.priv
          - pubkey: /etc/salt/secrets/ssh_keys/saltdeployer.pub

      - google_storage:
        - credentials: /etc/salt/secrets/gcp/credentials.json
        - project: {{ PILLAR_BUCKET_PROJECT }}
        - bucke_id: {{ PILLAR_BUCKET_ID }}
        - prefix: ".pem"

    ############################################
    # fileserver configuration

    fileserver_backend:
      - roots
      - gitfs

    gitfs_remotes:
      - git@github.com:Cookiiiies/salt.git

    gitfs_provider: pygit2

    gitfs_privkey: /etc/salt/secrets/ssh_keys/saltdeployer.priv

    gitfs_pubkey: /etc/salt/secrets/ssh_keys/saltdeployer.pub

    gitfs_root: 'salt'

    file_roots:
      base:
        - /srv/salt
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ DEPLOYMENT_NAME }}-nginx-proxy
  namespace: {{ NAMESPACE }}
data:
  salt-proxy.conf: |-
    server {
      listen 80;
      listen [::]:80;
      server_name {{ SALT_API_HOST }};
      return 301 https://$host$request_uri;
    }

    server {
      listen 443 default_server;
      listen [::]:443 default_server;
      server_name {{ SALT_API_HOST }};

      ssl on;
      ssl_protocols  TLSv1.2;
      ssl_certificate         /var/ssl/{{ SALT_API_HOST }}.bundle.pem;
      ssl_certificate_key     /var/ssl/{{ SALT_API_HOST }}.key.pem;
      server_name {{ SALT_API_HOST }} _;
      charset UTF-8;
      location /health {
        access_log off;
        return 200 "healthy\n";
      }
      location / {
        proxy_redirect off;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Ssl on;
        proxy_pass_header Server;
        proxy_read_timeout  3600;
        proxy_pass          http://localhost:8081;
      }
    }
